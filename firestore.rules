rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ──────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.token.email))
        && get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role == 'admin';
    }

    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email == email;
    }

    // ─── Users ─────────────────────────────────────────────────────
    // Auto-registration writes here on login. Users can update their
    // own doc but CANNOT set/change the 'role' field.
    match /users/{email} {
      allow read: if isAuthenticated();

      allow create: if isOwner(email)
                    && !('role' in request.resource.data);

      allow update: if (isOwner(email)
                    && request.resource.data.role == resource.data.role)
                    || isAdmin();

      allow delete: if isAdmin();
    }

    // ─── Navigation Permissions ────────────────────────────────────
    // Users read their own config + _default. Admin reads/writes all.
    match /navigation_permissions/{docId} {
      allow read: if isAuthenticated()
                  && (docId == '_default'
                      || docId == request.auth.token.email
                      || isAdmin());

      allow write: if isAdmin();
    }

    // ─── Shared Tasks (Operations board) ───────────────────────────
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }

    // ─── Personal Tasks ────────────────────────────────────────────
    match /user_tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }

    // ─── Leave Requests ────────────────────────────────────────────
    // Users can read/update only their own. Admin can read/update all.
    match /leave_requests/{requestId} {
      allow read: if isAuthenticated()
                  && (resource.data.userEmail == request.auth.token.email
                      || isAdmin());

      allow create: if isAuthenticated();

      allow update: if isAuthenticated()
                    && (resource.data.userEmail == request.auth.token.email
                        || isAdmin());

      allow delete: if isAdmin();
    }

    // ─── Products (admin-managed catalog) ──────────────────────────
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ─── Product Categories (admin-managed) ────────────────────────
    match /product_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ─── Bookstore Requests ────────────────────────────────────────
    match /bookstore_requests/{requestId} {
      allow read: if isAuthenticated()
                  && (resource.data.userEmail == request.auth.token.email
                      || isAdmin());

      allow create: if isAuthenticated();

      allow update, delete: if isAdmin();
    }
  }
}
