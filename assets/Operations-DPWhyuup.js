import{j as e,d as m,f as ve,g as je,a as ye,h as ke,u as De,r as i,i as j,k as Ce,q as Te,l as Ee,c as ie,o as Se,m as z,n as T,e as w,C as Ae,I as Ie,s as Me,p as Pe,t as Le}from"./index-zZ0VZZ4p.js";import{P as ze,M as ue,a as Fe,b as Oe,D as me,c as Be,C as xe}from"./progress-7-9TUhpN.js";import{T as Re,a as qe,b as pe,c as Ge}from"./tabs-BhBb3kdP.js";import{C as ge,T as Ue}from"./textarea-FeWkwKSv.js";import{C as He}from"./calendar-B9_EqBkT.js";import{C as Ke,f as J}from"./format-Cu5othT5.js";import{C as $e}from"./chevron-right-BSo9J0aP.js";import{U as Ve,e as he}from"./es-BuEom4ST.js";import{T as fe,P as ee}from"./trash-2-BdXGZdJo.js";import{E as _e}from"./external-link-DuUK5k6m.js";import"./index-crZK1vcL.js";const _=["General","Devolución","SAC","Operaciones"],be=({task:t,index:Q,expandedTasks:q,toggleExpand:N,updateTask:h,deleteTask:G,addSubtask:W,toggleSubtask:E,updateSubtaskTitle:F,deleteSubtask:U,departments:X})=>{var D,H;const k=((D=t.subtasks)==null?void 0:D.filter(u=>u.completed).length)||0,f=((H=t.subtasks)==null?void 0:H.length)||0,O=f>0?k/f*100:0,x=t.status==="done",p=q[t.id],S=new Date;S.setHours(0,0,0,0);const b=t.dueDate?new Date(t.dueDate+"T00:00:00")<S&&!x:!1,B=u=>J(new Date(u+"T00:00:00"),"dd MMM",{locale:he});return e.jsx(ze,{draggableId:t.id,index:Q,children:(u,Y)=>e.jsxs("div",{ref:u.innerRef,...u.draggableProps,...u.dragHandleProps,className:m("rounded-xl border border-border transition-colors",x?"bg-success/10 border-success/30":"bg-card",Y.isDragging&&"shadow-lg scale-[1.02] ring-2 ring-primary/20 z-50"),style:u.draggableProps.style,children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-3",children:[e.jsx("button",{onClick:()=>h(t.id,{status:x?"todo":"done"}),className:m("shrink-0 transition-theme",x?"text-success":"text-muted-foreground hover:text-primary"),children:x?e.jsx(He,{className:"h-5 w-5"}):e.jsx(Ke,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>N(t.id),className:"text-muted-foreground",children:p?e.jsx(ve,{className:"h-4 w-4"}):e.jsx($e,{className:"h-4 w-4"})}),t.notes&&e.jsx(ue,{className:"h-3 w-3 text-foreground fill-yellow-400 animate-pulse"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("input",{value:t.title,onChange:o=>h(t.id,{title:o.target.value}),onKeyDown:o=>o.key==="Enter"&&o.currentTarget.blur(),className:m("text-sm font-medium bg-transparent outline-none w-full",x?"text-success line-through":"text-foreground")}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-1.5 min-w-0",children:[f>0&&e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-[100px]",children:[e.jsx(Fe,{value:O,className:"h-1.5 flex-1"}),e.jsxs("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:[k,"/",f]})]}),t.createdBy&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground bg-muted/50 px-1.5 py-0.5 rounded border border-border",children:[e.jsx(Ve,{className:"h-2.5 w-2.5"}),e.jsx("span",{className:"truncate max-w-[120px]",children:t.createdBy})]}),t.createdAt&&e.jsx("span",{className:"text-xs text-muted-foreground",children:J(t.createdAt,"dd MMM",{locale:he})}),(t.startDate||t.dueDate)&&e.jsxs("div",{className:m("flex items-center gap-1 text-xs px-1.5 py-0.5 rounded border",b?"text-destructive bg-destructive/10 border-destructive/30":"text-muted-foreground bg-muted/50 border-border"),children:[e.jsx(ge,{className:"h-2.5 w-2.5"}),e.jsxs("span",{children:[t.startDate&&B(t.startDate),t.startDate&&t.dueDate&&" → ",t.dueDate&&B(t.dueDate)]})]})]})]}),e.jsx("select",{value:t.department,onChange:o=>h(t.id,{department:o.target.value}),onClick:o=>o.stopPropagation(),className:"text-xs text-muted-foreground bg-secondary px-2 py-0.5 rounded-full shrink-0 cursor-pointer border border-border outline-none focus:ring-1 focus:ring-ring appearance-none",children:X.map(o=>e.jsx("option",{value:o,children:o},o))}),e.jsx("button",{onClick:()=>G(t.id),className:"text-muted-foreground hover:text-destructive transition-theme",children:e.jsx(fe,{className:"h-3.5 w-3.5"})})]}),p&&e.jsxs("div",{className:"border-t border-border px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Subtareas (",k,"/",f,")"]}),e.jsxs(je,{variant:"ghost",size:"sm",onClick:()=>W(t.id),className:"h-6 text-xs gap-1",children:[e.jsx(ee,{className:"h-3 w-3"})," Agregar"]})]}),e.jsx("div",{className:"space-y-1",children:t.subtasks.map(o=>e.jsxs("div",{className:"group/sub flex items-center gap-2 rounded-lg bg-muted/50 px-3 py-1.5",children:[e.jsx("input",{type:"checkbox",checked:o.completed,onChange:()=>E(t.id,o.id),className:"accent-primary h-3.5 w-3.5"}),e.jsx("input",{value:o.title,onChange:Z=>F(t.id,o.id,Z.target.value),className:m("flex-1 bg-transparent text-sm text-foreground outline-none",o.completed&&"line-through text-muted-foreground")}),e.jsx("button",{onClick:()=>U(t.id,o.id),className:"opacity-0 group-hover/sub:opacity-100 text-muted-foreground hover:text-destructive transition-all",children:e.jsx(fe,{className:"h-3 w-3"})})]},o.id))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ge,{className:"h-3 w-3"})," Fechas"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("label",{className:"text-xs text-muted-foreground whitespace-nowrap w-10",children:"Inicio"}),e.jsx("input",{type:"date",value:t.startDate||"",onChange:o=>h(t.id,{startDate:o.target.value||void 0}),className:"h-8 flex-1 rounded-md border border-border bg-background px-2 text-xs text-foreground focus:outline-none focus:ring-1 focus:ring-ring"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("label",{className:m("text-xs whitespace-nowrap w-10",b?"text-destructive":"text-muted-foreground"),children:"Límite"}),e.jsx("input",{type:"date",value:t.dueDate||"",onChange:o=>h(t.id,{dueDate:o.target.value||void 0}),className:m("h-8 flex-1 rounded-md border px-2 text-xs focus:outline-none focus:ring-1 focus:ring-ring",b?"border-destructive/50 bg-destructive/5 text-destructive":"border-border bg-background text-foreground")})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ue,{className:"h-3 w-3"})," Notas"]}),e.jsx(Ue,{value:t.notes,onChange:o=>h(t.id,{notes:o.target.value}),placeholder:"Agregar notas...",className:"min-h-[60px] text-sm resize-none"})]})]})]})},t.id)},ns=()=>{const{user:t}=ye(),Q=ke(),q=De();i.useEffect(()=>{["librerias@bukz.co","museo@bukz.co","bogota109@bukz.co","vivaenvigado@bukz.co","lomas@bukz.co"].includes((t==null?void 0:t.email)||"")&&(q("/dashboard"),j.error("No tienes permisos para acceder a este módulo"))},[t,q]);const[N,h]=i.useState([]),[G,W]=i.useState({}),[E,F]=i.useState(""),[U,X]=i.useState("General"),[k,f]=i.useState(void 0),[O,x]=i.useState(void 0),[p,S]=i.useState(!1),[b,B]=i.useState(!1),[D,H]=i.useState("All"),u=()=>{!p||b||(B(!0),F(""),f(void 0),x(void 0))};i.useEffect(()=>{if(!p)return;const s=a=>{a.key==="Escape"&&u()};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[p,b]);const[Y,o]=Ce(),Z=Y.get("tab")||"tasks";i.useEffect(()=>{const s=Te(ie(w,"tasks"),Ee("createdAt","desc")),a=Se(s,r=>{const c=r.docs.map(n=>{var M,$,P,R;const l=n.data();return{id:n.id,...l,createdAt:(($=(M=l.createdAt)==null?void 0:M.toDate)==null?void 0:$.call(M))||new Date,order:l.order??((R=(P=l.createdAt)==null?void 0:P.toMillis)==null?void 0:R.call(P))??Date.now()}});c.sort((n,l)=>(l.order??0)-(n.order??0)),h(c)},r=>{console.error("Firestore subscription error:",r),j.error("Error al sincronizar tareas: "+r.message)});return()=>a()},[]);const we=s=>{if(s==="panel"){window.open("https://paneloperacionesbukz.streamlit.app/","_blank");return}o({tab:s})},se=async()=>{if(E.trim())try{const s={title:E.trim(),department:U,status:"todo",notes:"",subtasks:[],createdBy:(t==null?void 0:t.email)||"Usuario desconocido",createdAt:Me(),order:Date.now()};k&&(s.startDate=J(k,"yyyy-MM-dd")),O&&(s.dueDate=J(O,"yyyy-MM-dd")),await Pe(ie(w,"tasks"),s),F(""),f(""),x(""),S(!1),j.success("Tarea agregada correctamente")}catch(s){console.error("Error adding task:",s),j.error("Error al agregar tarea: "+s.message)}},te=s=>{W(a=>({...a,[s]:!a[s]}))},re=async(s,a)=>{try{const r=T(w,"tasks",s);await z(r,a)}catch(r){console.error("Error updating task:",r),j.error("Error al actualizar tarea")}},ae=async s=>{try{await Le(T(w,"tasks",s)),j.success("Tarea eliminada")}catch(a){console.error("Error deleting task:",a),j.error("Error al eliminar tarea")}},oe=async s=>{const a=N.find(c=>c.id===s);if(!a)return;const r={id:`s${Date.now()}`,title:"Nueva subtarea",completed:!1};try{await z(T(w,"tasks",s),{subtasks:[...a.subtasks,r]})}catch(c){console.error("Error adding subtask:",c)}},ne=async(s,a)=>{const r=N.find(n=>n.id===s);if(!r)return;const c=r.subtasks.map(n=>n.id===a?{...n,completed:!n.completed}:n);try{await z(T(w,"tasks",s),{subtasks:c})}catch(n){console.error("Error toggling subtask:",n)}},de=async(s,a,r)=>{const c=N.find(l=>l.id===s);if(!c)return;const n=c.subtasks.map(l=>l.id===a?{...l,title:r}:l);try{await z(T(w,"tasks",s),{subtasks:n})}catch(l){console.error("Error updating subtask title:",l)}},le=async(s,a)=>{const r=N.find(n=>n.id===s);if(!r)return;const c=r.subtasks.filter(n=>n.id!==a);try{await z(T(w,"tasks",s),{subtasks:c})}catch(n){console.error("Error deleting subtask:",n),j.error("Error al eliminar la subtarea")}},K=i.useMemo(()=>N.filter(s=>D==="All"||s.department===D),[N,D]),A=i.useMemo(()=>K.filter(s=>s.status!=="done"),[K]),I=i.useMemo(()=>K.filter(s=>s.status==="done"),[K]),Ne=i.useCallback(async s=>{const{source:a,destination:r,draggableId:c}=s;if(!r||a.droppableId===r.droppableId&&a.index===r.index)return;const n=a.droppableId,l=r.droppableId,M=n==="pending",$=l==="pending",P=M?A:I,R=$?A:I;let g=0,ce=[...Array.from(R)];if(n===l){const[d]=ce.splice(a.index,1);ce.splice(r.index,0,d)}if(n===l){const d=Array.from(P),[C]=d.splice(a.index,1);d.splice(r.index,0,C);const v=d[r.index-1],y=d[r.index+1],L=v?v.order??0:null,V=y?y.order??0:null;v&&y?g=((L??0)+(V??0))/2:v?g=(L??0)-1e5:y?g=(V??0)+1e5:g=Date.now()}else{const d=R;if(d.length===0)g=Date.now();else if(r.index===0)g=(d[0].order??0)+1e5;else if(r.index>=d.length)g=(d[d.length-1].order??0)-1e5;else{const C=d[r.index-1],v=d[r.index];g=((C.order??0)+(v.order??0))/2}}h(d=>{const C=d.findIndex(L=>L.id===c);if(C===-1)return d;const v={...d[C],order:g,status:l==="completed"?"done":"todo"},y=[...d];return y[C]=v,y.sort((L,V)=>(V.order??0)-(L.order??0)),y});try{const d={order:g};n!==l&&(d.status=l==="completed"?"done":"todo"),await z(T(w,"tasks",c),d)}catch(d){console.error("Error moving task:",d),j.error("Error al mover la tarea")}},[A,I]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-foreground",children:"Operaciones"}),e.jsx("p",{className:"mt-1 text-base text-muted-foreground",children:"Gestión operativa y archivos del equipo"})]}),e.jsxs(Re,{value:Z,onValueChange:we,className:"w-full space-y-6",children:[e.jsxs(qe,{className:"bg-muted/50 p-1",children:[e.jsxs(pe,{value:"tasks",className:"gap-2",children:[e.jsx(Ae,{className:"h-4 w-4"}),"Tareas entre áreas"]}),e.jsxs(pe,{value:"panel",className:"gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),"Panel Operaciones"]})]}),e.jsxs(Ge,{value:"tasks",className:"space-y-6 mt-0",children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>{p?u():S(!0)},className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors group",children:[e.jsx("span",{className:m("flex items-center justify-center h-6 w-6 rounded-full border transition-all",p?"border-yellow-400 bg-yellow-400/20 text-black dark:text-yellow-500":"border-yellow-400/60 bg-yellow-400/10 group-hover:bg-yellow-400/20 group-hover:border-yellow-400 text-black dark:text-yellow-500"),children:p?e.jsx(Oe,{className:"h-3.5 w-3.5"}):e.jsx(ee,{className:"h-3.5 w-3.5"})}),"Nueva tarea"]}),(p||b)&&e.jsxs("div",{onAnimationEnd:()=>{b&&(S(!1),B(!1))},className:m("flex flex-col gap-2 bg-card p-3 rounded-xl border border-primary/20 shadow-sm max-w-lg mt-2 overflow-hidden",b?"animate-out fade-out slide-out-to-top-2 duration-200 fill-mode-forwards":"animate-in fade-in slide-in-from-top-2 duration-200"),children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[e.jsx(Ie,{placeholder:"Título de la tarea...",value:E,onChange:s=>F(s.target.value),onKeyDown:s=>s.key==="Enter"&&se(),autoFocus:!0,className:"h-8 text-sm px-3 flex-1 min-w-0"}),e.jsx("select",{value:U,onChange:s=>X(s.target.value),className:"h-8 rounded-md border border-border bg-background px-2 text-xs text-muted-foreground shrink-0 cursor-pointer focus:outline-none focus:ring-1 focus:ring-ring appearance-none",children:_.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap min-w-0",children:[e.jsx(me,{value:k,onChange:f,placeholder:"Inicio",className:"h-7 w-auto max-w-[140px] text-xs"}),e.jsx(me,{value:O,onChange:x,placeholder:"Límite",className:"h-7 w-auto max-w-[140px] text-xs"}),e.jsx("div",{className:"flex-1"}),e.jsxs(je,{size:"sm",onClick:se,disabled:!E.trim(),className:"h-7 text-xs px-3 gap-1 shrink-0",children:[e.jsx(ee,{className:"h-3 w-3"})," Agregar"]})]})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:["All",..._].map(s=>e.jsx("button",{onClick:()=>H(s),className:m("rounded-full px-3 py-1 text-xs font-medium transition-theme border",D===s?"bg-primary text-primary-foreground border-primary":"bg-muted text-muted-foreground hover:bg-secondary border-border"),children:s==="All"?"Todos":s},s))}),e.jsx(Be,{onDragEnd:Ne,children:e.jsxs("div",{className:m("grid gap-4 md:gap-6",Q?"grid-cols-1":"lg:grid-cols-2"),children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-sm font-medium text-muted-foreground mb-3",children:["Pendientes (",A.length,")"]}),e.jsx(xe,{droppableId:"pending",children:s=>e.jsxs("div",{ref:s.innerRef,...s.droppableProps,className:"space-y-2 min-h-[100px] rounded-xl border border-dashed border-border p-3",children:[A.map((a,r)=>e.jsx(be,{task:a,index:r,expandedTasks:G,toggleExpand:te,updateTask:re,deleteTask:ae,addSubtask:oe,toggleSubtask:ne,updateSubtaskTitle:de,deleteSubtask:le,departments:_},a.id)),A.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-8",children:"No hay tareas pendientes"}),s.placeholder]})})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-sm font-medium text-success mb-3",children:["Completadas (",I.length,")"]}),e.jsx(xe,{droppableId:"completed",children:s=>e.jsxs("div",{ref:s.innerRef,...s.droppableProps,className:"space-y-2 min-h-[100px] rounded-xl border border-dashed border-success/30 bg-success/5 p-3",children:[I.map((a,r)=>e.jsx(be,{task:a,index:r,expandedTasks:G,toggleExpand:te,updateTask:re,deleteTask:ae,addSubtask:oe,toggleSubtask:ne,updateSubtaskTitle:de,deleteSubtask:le,departments:_},a.id)),I.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-8",children:"No hay tareas completadas"}),s.placeholder]})})]})]})})]})]})]})};export{ns as default};
